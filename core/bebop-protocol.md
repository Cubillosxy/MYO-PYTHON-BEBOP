# Parrot Bebop Protocol

*This is not an official documentation - it is based on ![Parrot ARDrone3 SDK](https://github.com/ARDroneSDK3) and
my experiences. I do not want to start every sentence "as far as I know" and "I
think" ;-) ... so if you find mistake or some part is not clear please let me
know.*


## Discovery

The communication is UDP based except initial discovery session which is TCP
connection on port 44444.

Open TCP port 44444 and send following JSON:
```json
{"controller_type":"computer", "controller_name":"katarina", "d2c_port":"43210"}
```

You should receive something like as confirmation: 
```json
{ "status": 0, "c2d_port": 54321, "arstream_fragment_size": 1000,
"arstream_fragment_maximum_number": 128, "arstream_max_ack_interval": 0,
"c2d_update_port": 51, "c2d_user_port": 21 } 
```

After that you can start to send data via commands port and receive navdata
from the drone.


## UDP Communication

There are two UDP ports: c2d/commands (port 54321) and d2c/navdata (port 43210)
used for communication (the host IP is typically **192.168.42.1**).

All data (including video frames) are transfered this way. There is only one
port to send commands and only one port to receive drone data. On the other
hand there are several "channels" identified by first two bytes of the
packet:

* standard data
* data requiring acknowledgement
* video data
* ping-pong data

The header of every packet contains length (4bytes) and growing sequence packet
index within given channel (1byte). Next bytes depend on the type of channel
and message.


### Commands

All commands have form of triple (projectId, classId, commandId) corresponding
to (uint8, uint8, uint16). The list of all available commands is generated from
XML files: ![libARCommands](https://github.com/ARDroneSDK3/libARCommands)/(
![ARDrone3_commands.xml](https://github.com/ARDroneSDK3/libARCommands/blob/master/Xml/ARDrone3_commands.xml),
![ARDrone3_debug.xml](https://github.com/ARDroneSDK3/libARCommands/blob/master/Xml/ARDrone3_debug.xml),
![common_commands.xml](https://github.com/ARDroneSDK3/libARCommands/blob/master/Xml/common_commands.xml)
and 
![common_debug.xml](https://github.com/ARDroneSDK3/libARCommands/blob/master/Xml/common_debug.xml)).
The C-language enum is generated by
![generateLibARCommands.py](https://github.com/ARDroneSDK3/libARCommands/blob/master/Xml/generateLibARCommands.py)
script.

The parameters and their sizes are also defined in XML files. In particular be
aware that "enum" requires 4 bytes.

To send command you need to use "channel" number 10.


### Standard Data

The standard data have the same structure as commands, i.e. triples (projectId,
classId, commandId) followed by message specific variables (again described in
XML file).



### Data Requiring Acknowledgement

If the first byte is ARNETWORKAL_FRAME_TYPE_DATA_WITH_ACK = 0x4 it is necessary
to confirm reception with ACK. The ACK payload is only one byte containing
sequence number of received data. The destination channel is 0xFE.


### Video Data

Video data are H.264 encoded video frames split into small (approx 1kB large)
fragments. The video data have to be confirmed by special message with 128bit
mask. Every received video block contains frame number, flags (1 = I-frame, 0 =
P-frame), fragment number and number of fragments per frame. There is one bit
per fragment in the video acknowledge message. 


### Ping-pong Data

Drone sends approximately twice a second "ping" packet. It is necessary to take
received data (containing timestamp) and send them back.

### Sending PCMD Data

Once you are sending motion commands (PCMD) make sure you are sending them with
fixed frequency even if it is repetition of the same command. Free Flight is
using 40Hz. Otherwise you may loose your video streaming as the Drone is
interpreting non-regular PCMD as "bad wifi". See [1].


[1] https://github.com/ARDroneSDK3/libARCommands/issues/4

